<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta CEP • OpenStreetMap</title>
  <meta name="description" content="Site simples para buscar CEP a partir de um ponto no mapa, endereço ou CEP, usando dados do OpenStreetMap (Nominatim/Overpass)." />
  <link rel="preconnect" href="https://{s}.tile.openstreetmap.org" crossorigin>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #101828;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --brand: #22c55e;
      --brand-600: #16a34a;
      --danger: #ef4444;
      --card: #0f172a;
      --chip: #1e293b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; display: grid; grid-template-columns: 360px 1fr; grid-template-rows: 1fr;
      color: var(--text); background: linear-gradient(180deg, #0b1220 0%, #0b1220 60%, #0a0f1a 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    aside {
      height: 100vh; overflow: auto; padding: 18px; border-right: 1px solid rgba(148,163,184,.15);
      background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0) 100%);
    }
    .brand {
      display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
    }
    .logo {
      width: 36px; height: 36px; border-radius: 10px; background: radial-gradient(circle at 30% 30%, #22c55e 0%, #16a34a 40%, #0f172a 100%);
      box-shadow: 0 4px 20px rgba(34,197,94,.35);
    }
    h1 { font-size: 20px; margin: 0; letter-spacing: .2px; }
    .panel { background: var(--panel); border: 1px solid rgba(148,163,184,.15); border-radius: 16px; padding: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.25) inset, 0 10px 30px rgba(0,0,0,.2); }
    .section { margin: 12px 0 16px; }
    label { display:block; font-size:12px; color: var(--muted); margin-bottom:6px; }
    input, button, select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(148,163,184,.18);
      background: #0b1220; color: var(--text);
      outline: none; transition: border .2s, transform .06s ease;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(34,197,94,.15); }
    button { cursor: pointer; font-weight: 600; background: linear-gradient(180deg, var(--brand) 0%, var(--brand-600) 100%); border: none; }
    button:hover { filter: brightness(0.95); }
    button:active { transform: translateY(1px); }
    .grid { display: grid; gap: 10px; }
    .grid2 { grid-template-columns: 1fr 1fr; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
    .chip { font-size: 12px; padding: 6px 8px; background: var(--chip); border: 1px solid rgba(148,163,184,.15); border-radius: 999px; }
    .result { background: var(--card); border: 1px solid rgba(148,163,184,.15); border-radius: 14px; padding: 10px; margin-top: 10px; }
    .result h3 { margin: 0 0 6px; font-size: 14px; }
    #map { height: 100vh; width: 100%; }
    .footer { font-size: 11px; color: var(--muted); margin-top: 14px; line-height: 1.4; }
    .row { display:flex; gap:8px; }
    .row > * { flex: 1; }
    .danger { background: linear-gradient(180deg, #ef4444, #b91c1c); }
    .link { color: #93c5fd; text-decoration: none; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0f172a; border:1px solid rgba(148,163,184,.2); padding:2px 6px; border-radius:6px; font-size:12px; }
  </style>
</head>
<body>
  <aside>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>CEP • OpenStreetMap</h1>
    </div>

    <div class="panel section">
      <div class="grid">
        <div>
          <label for="cep">Buscar por CEP</label>
          <div class="row">
            <input id="cep" placeholder="Ex: 50791-460" maxlength="9" />
            <button id="btnCep">Buscar</button>
          </div>
          <div class="hint">Dica: digite com ou sem hífen. País padrão: Brasil.</div>
        </div>
        <hr style="border: none; border-top: 1px solid rgba(148,163,184,.15); margin: 6px 0;">
        <div>
          <label>Buscar por endereço</label>
          <input id="endereco" placeholder="Rua, bairro, cidade, estado" />
          <div class="row">
            <button id="btnEnd">Buscar endereço</button>
            <button id="btnLimpar" class="danger">Limpar</button>
          </div>
          <div class="hint">Resultado mostra o CEP (se disponível) e centraliza o mapa.</div>
        </div>
      </div>
    </div>

    <div class="panel section">
      <label>Ferramentas</label>
      <div class="grid grid2">
        <button id="btnMeuLocal">Ir para minha localização</button>
        <button id="btnCopiar">Copiar CEP</button>
      </div>
      <div class="chips">
        <span class="chip">Clique no mapa → CEP</span>
        <span class="chip">Shift + Arrastar → medir área</span>
        <span class="chip">Mousewheel → zoom</span>
      </div>
      <div class="hint">As áreas de CEP nem sempre existem no OSM. A busca usa Nominatim; pontos com <code class="kbd">addr:postcode</code> são mostrados.
      </div>
    </div>

    <div class="panel section">
      <label>Resultados</label>
      <div id="resultados"></div>
    </div>

    <div class="footer">
      Baseado em dados do <a class="link" href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a>. Respeite os <a class="link" href="https://operations.osmfoundation.org/policies/nominatim/" target="_blank" rel="noopener">termos do Nominatim</a> e <a class="link" href="https://operations.osmfoundation.org/policies/api/" target="_blank" rel="noopener">Overpass API</a>. Este é um protótipo educativo.
    </div>
  </aside>

  <main id="map"></main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ===== Util =====
    const $ = (sel) => document.querySelector(sel);
    const fmtCEP = (v) => (v || '').replace(/\D/g, '').replace(/(\d{5})(\d{1,3})/, '$1-$2');
    const toast = (msg, type='info') => {
      console.log(`[${type}]`, msg);
    };

    // ===== Map =====
    const map = L.map('map', { zoomControl: true }).setView([-14.235, -51.9253], 4);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contrib.'
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);
    const addrLayer = L.geoJSON(null, {
      style: { color: '#22c55e', weight: 2, opacity: .8, fillOpacity: .1 }
    }).addTo(map);

    let lastCEP = '';

    // ===== Nominatim helpers =====
    const NOM_BASE = 'https://nominatim.openstreetmap.org';
    const headers = { 'Accept': 'application/json' };

    async function search(q, extra={}) {
      const params = new URLSearchParams({
        format: 'jsonv2',
        q,
        addressdetails: '1',
        countrycodes: 'br',
        polygon_geojson: '1',
        limit: '6',
        ...extra,
      });
      const url = `${NOM_BASE}/search?${params.toString()}`;
      const r = await fetch(url, { headers });
      if (!r.ok) throw new Error('Falha na busca');
      return r.json();
    }

    async function reverse(lat, lon) {
      const params = new URLSearchParams({ format: 'jsonv2', lat, lon, addressdetails: '1', zoom: '18' });
      const url = `${NOM_BASE}/reverse?${params.toString()}`;
      const r = await fetch(url, { headers });
      if (!r.ok) throw new Error('Falha no reverse');
      return r.json();
    }

    // ===== Overpass: pontos/áreas com CEP no bbox atual =====
    async function overpassCEP(bbox) {
      const q = `[
        out:json][timeout:20];(
          node["addr:postcode"](${bbox});
          way["addr:postcode"](${bbox});
          relation["addr:postcode"](${bbox});
        );out center 100;`;
      const r = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ data: q }).toString()
      });
      if (!r.ok) throw new Error('Overpass indisponível');
      const json = await r.json();
      return json.elements || [];
    }

    // ===== UI actions =====
    function renderResult(item, idx=0) {
      const el = document.createElement('div');
      el.className = 'result';
      const addr = item.address || {};
      const cep = addr.postcode || item.postcode || '';
      lastCEP = cep || lastCEP;
      const title = item.display_name || 'Resultado';
      el.innerHTML = `
        <h3>${idx+1}. ${cep ? 'CEP ' + fmtCEP(cep) : 'CEP não encontrado'}</h3>
        <div style="font-size:13px; opacity:.9;">${title}</div>
        <div class="chips" style="margin-top:8px;">
          ${cep ? `<span class="chip">${fmtCEP(cep)}</span>` : ''}
          ${addr.road ? `<span class="chip">${addr.road}</span>` : ''}
          ${addr.suburb ? `<span class="chip">${addr.suburb}</span>` : ''}
          ${addr.city || addr.town || addr.village ? `<span class="chip">${addr.city||addr.town||addr.village}</span>` : ''}
          ${addr.state ? `<span class="chip">${addr.state}</span>` : ''}
        </div>
      `;
      $('#resultados').prepend(el);
    }

    function focusMapFromNom(item) {
      markers.clearLayers();
      addrLayer.clearLayers();
      const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
      const m = L.marker([lat, lon]).addTo(markers);
      if (item.geojson) {
        addrLayer.addData(item.geojson);
        try {
          const gjBounds = L.geoJSON(item.geojson).getBounds();
          if (gjBounds.isValid()) { map.fitBounds(gjBounds.pad(0.2)); return; }
        } catch {}
      }
      map.setView([lat, lon], 17);
    }

    $('#btnEnd').addEventListener('click', async () => {
      const q = $('#endereco').value.trim();
      if (!q) return;
      $('#resultados').innerHTML = '';
      try {
        const res = await search(q);
        if (!res.length) { toast('Nenhum resultado', 'warn'); return; }
        res.slice(0,3).forEach((it, i) => renderResult(it, i));
        focusMapFromNom(res[0]);
      } catch (e) {
        toast(e.message, 'error');
      }
    });

    $('#btnCep').addEventListener('click', async () => {
      const raw = $('#cep').value.trim();
      const cep = raw.replace(/\D/g, '');
      if (cep.length < 8) { toast('CEP inválido', 'warn'); return; }
      $('#resultados').innerHTML = '';
      try {
        const res = await search(cep, { extratags: '1' });
        if (!res.length) { toast('CEP não encontrado no OSM', 'warn'); return; }
        res.slice(0,3).forEach((it, i) => renderResult(it, i));
        focusMapFromNom(res[0]);
      } catch (e) {
        toast(e.message, 'error');
      }
    });

    $('#btnLimpar').addEventListener('click', () => {
      $('#endereco').value = '';
      $('#cep').value = '';
      $('#resultados').innerHTML = '';
      markers.clearLayers(); addrLayer.clearLayers();
      map.setView([-14.235, -51.9253], 4);
    });

    $('#btnMeuLocal').addEventListener('click', () => {
      map.locate({ setView: true, maxZoom: 17 });
    });

    $('#btnCopiar').addEventListener('click', async () => {
      if (!lastCEP) { toast('Sem CEP no histórico'); return; }
      try { await navigator.clipboard.writeText(fmtCEP(lastCEP)); toast('CEP copiado!'); }
      catch { toast('Falha ao copiar'); }
    });

    // Clique no mapa → reverse geocoding
    map.on('click', async (e) => {
      try {
        const r = await reverse(e.latlng.lat, e.latlng.lng);
        renderResult(r, 0);
        // Gerar GeoJSON simples do ponto clicado
        markers.clearLayers(); addrLayer.clearLayers();
        const m = L.marker(e.latlng).addTo(markers);
        map.setView(e.latlng, 18);
      } catch (err) {
        toast(err.message, 'error');
      }
    });

    // Botão: Carregar pontos com addr:postcode no bbox atual
    const btnOver = document.createElement('button');
    btnOver.textContent = 'Exibir endereços com CEP na área';
    btnOver.style.marginTop = '10px';
    $('.panel.section .chips').after(btnOver);

    btnOver.addEventListener('click', async () => {
      const b = map.getBounds();
      const south = b.getSouth().toFixed(6), west = b.getWest().toFixed(6), north = b.getNorth().toFixed(6), east = b.getEast().toFixed(6);
      const areaKm2 = (Math.abs(north - south) * 111) * (Math.abs(east - west) * 111 * Math.cos((+south+ +north)/2 * Math.PI/180));
      if (areaKm2 > 400) { alert('Área muito grande. Aproxime o zoom e tente novamente.'); return; }
      try {
        const elements = await overpassCEP(`${south},${west},${north},${east}`);
        markers.clearLayers();
        let count = 0;
        elements.forEach(el => {
          let lat, lon, cep;
          if (el.type === 'node') { lat = el.lat; lon = el.lon; }
          if (el.center) { lat = el.center.lat; lon = el.center.lon; }
          if (!lat || !lon) return;
          cep = el.tags && (el.tags['addr:postcode'] || el.tags.postal_code);
          const mk = L.circleMarker([lat, lon], { radius: 5, weight: 1, color: '#22c55e', fillOpacity: .6 });
          mk.bindTooltip(cep ? `CEP ${fmtCEP(cep)}` : 'Endereço com CEP');
          mk.addTo(markers);
          count++;
        });
        toast(`${count} elementos com CEP`, 'info');
      } catch (e) {
        alert('Falha ao buscar no Overpass. Tente novamente mais tarde.');
      }
    });

    // UX: Enter para buscar
    $('#cep').addEventListener('keydown', (ev) => { if (ev.key === 'Enter') $('#btnCep').click(); });
    $('#endereco').addEventListener('keydown', (ev) => { if (ev.key === 'Enter') $('#btnEnd').click(); });

  </script>
</body>
</html>
